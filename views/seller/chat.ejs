<% layout('../layout/boilerplate') %>
    <style>
        .customer {
            display: flex;
            justify-content: end;
            padding: 10px;
            background-color: lightsteelblue;
            width: fit-content;
            border-radius: 10px;
            margin: 10px;
        }

        .seller {
            display: flex;
            justify-content: start;
            padding: 10px;
            background-color: lightcyan;
            width: fit-content;
            border-radius: 10px;
            margin: 10px;
        }

        #chatMessages {
            height: 700px;
            /* Example fixed height */
            overflow-y: auto;

            /* Ensure vertical scrolling */
        }
    </style>
    <br>
    <section id="chatMessages" class="container">
        <% if(chat) {%>
            <h3 class="ms-3 p-3 sticky-top" style="background-color: rgb(215, 231, 247); border-radius: 10px;">
                <span>
                    <img src="<%= customer.profilePic %>"
                    style="border-radius: 100%; object-fit: cover; height:60px; width: 60px;"
                        class="img-thumbnail m-1" alt="">
                </span>
                <%= customer.username.charAt(0).toUpperCase() + customer.username.slice(1) %>
            </h3> <br><br>
            <% for(let message of chat.messages){ %>
                <% if(message.sender=='seller' ) {%>
                    <div style="display: flex; justify-content: end;">
                        <p style="display: flex; justify-content: end; width: fit-content;" class="seller"><strong>
                                You :&nbsp;&nbsp;
                            </strong>
                            <%= message.content %> &nbsp; <%= message.timestamp.getHours() % 12 || 12 %> : <%=
                                        String(message.timestamp.getMinutes()).padStart(2, '0' ) %> &nbsp; <svg
                                            xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="blue"
                                            class="bi bi-check2-all mt-1" viewBox="0 0 16 16">
                                            <path
                                                d="M12.354 4.354a.5.5 0 0 0-.708-.708L5 10.293 1.854 7.146a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0zm-4.208 7-.896-.897.707-.707.543.543 6.646-6.647a.5.5 0 0 1 .708.708l-7 7a.5.5 0 0 1-.708 0" />
                                            <path d="m5.354 7.146.896.897-.707.707-.897-.896a.5.5 0 1 1 .708-.708" />
                                        </svg>
                        </p>
                    </div>
                    <% } else { %>
                        <div>
                            <p style="display: flex; justify-content: start;" class="customer"><strong>
                                    <%= customer.username %>:&nbsp;&nbsp;
                                </strong>
                                <%= message.content %> &nbsp; <%= message.timestamp.getHours() % 12 || 12 %> : <%=
                                            String(message.timestamp.getMinutes()).padStart(2, '0' ) %> &nbsp;
                                            <% } %>
                        </div>
                        <% } %>
                            <% }else{ %>
                                <h1>nothing to see here</h1>
                                <% } %>
    </section><br>

    <br>
    <div class="fixed-bottom container">
        <form class="d-flex gap-1">
            <input type="text" class="form-control  m-1" name="message" id="message" style="border: 1px solid black;">
            <button type="submit" class="btn btn-primary m-1"
                onclick="sendMessage('<%= customerId  %>','<%= seller._id  %>')"><svg xmlns="http://www.w3.org/2000/svg"
                    width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                    <path
                        d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z" />
                </svg></button>
        </form>
    </div>


    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        socket.emit('joinRoom', 'roomName');

        socket.on('client_connected', (data) => {
            console.log(data);
        });

        function sendMessage(customerId, sellerId) {
            const messageInput = document.querySelector('#message');
            const messageContent = messageInput.value;
            const sender = 'seller' // Getting the sender from the role element
            socket.emit('sendMessage', {
                customerId,  // Pass the customer ID
                sellerId,    // Pass the seller ID
                message: {   // Construct the message object
                    sender: sender,
                    content: messageContent  // Corrected 'content' typo
                }
            });
            messageInput.value = ''; // Clear input after sending
            const chatMessages = document.querySelector('#chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        socket.on('newMessage', (messageData) => {
            console.log('got the message!!');
            const { content, sender, timestamp } = messageData;
            console.log(content, sender, timestamp);
            const chatMessages = document.querySelector('#chatMessages');
            const messageElement = document.createElement('p');
            const timestamp1 = new Date(timestamp);

            // Set innerHTML for messageElement
            if (sender == 'seller') {
                messageElement.innerHTML = `<strong>${sender}: &nbsp;&nbsp; </strong> ${content} &nbsp;  ${timestamp1.getHours() % 12 || 12} : ${String(timestamp1.getMinutes()).padStart(2, '0')} &nbsp; <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="blue" class="bi bi-check2-all mt-1" viewBox="0 0 16 16">
<path d="M12.354 4.354a.5.5 0 0 0-.708-.708L5 10.293 1.854 7.146a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0zm-4.208 7-.896-.897.707-.707.543.543 6.646-6.647a.5.5 0 0 1 .708.708l-7 7a.5.5 0 0 1-.708 0"/>
<path d="m5.354 7.146.896.897-.707.707-.897-.896a.5.5 0 1 1 .708-.708"/>
</svg>`;
            } else {
                messageElement.innerHTML = `<strong>${sender}: &nbsp;&nbsp; </strong> ${content} &nbsp;  ${timestamp1.getHours() % 12 || 12} : ${String(timestamp1.getMinutes()).padStart(2, '0')} &nbsp; `;
            }

            // Apply styles based on sender
            if (sender == 'seller') {
                messageElement.classList.add('seller');
            } else {
                messageElement.classList.add('customer');
            }

            // Append messageElement to chatMessages
            chatMessages.appendChild(messageElement);

            // Scroll to the bottom of the chat container
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });


        const chatMessages = document.querySelector('#chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;

    </script>
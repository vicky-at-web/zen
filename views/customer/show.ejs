<% layout('../layout/templates/customer/boilerplate') -%>
    <script defer src="/javascripts/validations.js"></script>


    <link rel="stylesheet" href="/stylesheets/button_animation.css">
    <div class="container">
        <div class="row mt-3 p-4">
            <div class="col-md-6 mt-4">
                <div class="container mb-4">
                    <div class="d-flex flex-column justify-content-center container">
                        <div id="carouselExampleFade" class="carousel slide carousel-fade mb-3">
                            <div class="carousel-inner">
                                <center>
                                    <div class="carousel-item active">
                                        <img src=" <%= product.imageUrl[0] %>" class="img-fluid"
                                            style="width: auto; height: 60%" alt="...">
                                    </div>
                                    <% for(let i=1; i<product.imageUrl.length; i++) {%>
                                        <div class="carousel-item">
                                            <img src="<%= product.imageUrl[i] %>" class="img-fluid" alt="...">
                                        </div>
                                        <% } %>
                                </center>
                            </div>
                        </div>
                        <div class="d-flex justify-content-center container">
                            <% if(product.imageUrl.length>1){ %>
                                <button style="color: black; background-color: white;  border: 0px" type="button"
                                    data-bs-target="#carouselExampleFade" data-bs-slide="prev">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
                                        class="bi bi-caret-left-fill" viewBox="0 0 16 16">
                                        <path
                                            d="m3.86 8.753 5.482 4.796c.646.566 1.658.106 1.658-.753V3.204a1 1 0 0 0-1.659-.753l-5.48 4.796a1 1 0 0 0 0 1.506z" />
                                    </svg>
                                </button>
                                <% } %>
                                    <div class="mx-4">
                                        <% for(let i=0; i<product.imageUrl.length; i++) {%>
                                            <img src="<%= product.imageUrl[i] %>" class="img-fluid img-thumbnail m-1"
                                                width="100" height="100" alt="...">
                                            <% } %>
                                    </div>
                                    <% if(product.imageUrl.length>1){ %>
                                        <button type="button" style="background-color: white;  border: 0px"
                                            data-bs-target="#carouselExampleFade" data-bs-slide="next">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
                                                class="bi bi-play-fill" viewBox="0 0 16 16">
                                                <path
                                                    d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393" />
                                            </svg>
                                        </button>
                                        <% } %>
                        </div>
                    </div>
                </div>
                <center>
                    <div class="card text-muted d-flex flex-row justify-content-around" style="width: fit-content;">
                        <form action="/customer/<%= product.id %>/cart" method="post">
                            <button class="btn btn-warning rounded btn-sm  py-2 px-3 m-2">Add To Cart</button>
                        </form>
                        <form action="/customer/<%= product.id %>/buynow">
                            <button class="btn btn-primary rounded py-2 px-3 btn-sm ms-2 my-2 me-1" type="submit">Buy
                                Now</button>
                        </form>
                        <% if(favoriteProductIds.includes(product._id)) {%>
                            <form action="/customer/<%= product.id %>/products/favourites?_method=DELETE" method="post"
                                class="m-2">
                                <button class="rbutton rounded ">
                                    Remove from Favs &nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="16"
                                        height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                                        <path
                                            d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5" />
                                    </svg>
                                </button>
                            </form>
                            <% }else{ %>
                                <form action="/customer/<%= product.id %>/products/favourites" class=" m-2"
                                    method="post" id="myForm">
                                    <button class="button rounded ">
                                        Add to Favs &nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            fill="currentColor" class="bi bi-suit-heart-fill mb-1" viewBox="0 0 16 16">
                                            <path
                                                d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1" />
                                        </svg>
                                    </button>
                                </form>
                                <% } %>
                    </div>
                    <br>
                </center>
                <br>
                <h4>More Details of the <%= product.name %>
                </h4>
                <ul class="list-group">
                    <li class="list-group-item">
                        <% function renderDetails(obj) { %>
                            <% Object.keys(obj).forEach(key=> { %>
                                <% if (typeof obj[key]==='object' ) { %>
                                    <strong>
                                        <%= key %>:
                                    </strong><br>
                                    <% renderDetails(obj[key]); %>
                                        <% } else { %>
                                            <%= key + ': ' + obj[key] %><br>
                                                <% } %>
                                                    <% }); %>
                                                        <% } %>
                                                            <% renderDetails(details); %>
                    </li>

                    <!-- <li class="list-group-item">A second item</li>
                    <li class="list-group-item">A third item</li>
                    <li class="list-group-item">A fourth item</li>
                    <li class="list-group-item">And a fifth one</li> -->
                </ul> <br>

                <div class="card mb-2">
                    <div class="card-body">
                        <form action="/customer/product/<%= product.id %>/searchqueries&reviews" class="form-valid"
                            novalidate>
                            <label for="text" class="form-label">Search by Text over Queries and Reviews:</label>
                            <input type="text" name="text" class="form-control mb-2" required>
                            <div class="valid-feedback">
                                Looks good!
                            </div>
                            <div class="invalid-feedback">
                                Please give a title!
                            </div>
                            <button class="btn btn-primary btn-sm" type="submit">Search</button>
                        </form>
                    </div>
                </div>


                <div class="card mb-2">
                    <div class="card-body">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#queryModel">
                            Ask Your Queries
                        </button>
                    </div>
                </div>

                <div class="modal fade" id="queryModel" tabindex="-1" aria-labelledby="queryModelLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="queryModelLabel">Ask Your Queries</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">

                                        
                                        <form action='/customer/products/<%= product.id %>/queries' method="post"
                                            id="queryForm" class="p-1">
                                            <label for="query" class="form-label">Query:</label>
                                            <input type="text" class="form-control p-2 mb-1 " id="query"
                                                name="query[question]">
                                                <label for="querytags" class="form-label">Add Tags: &nbsp; <span class="fs-6">(use commas to separate tags  eg., [nice, cool, good])</span></label>

                                            <input type="text" class="form-control p-2 mb-1 " id="querytags"
                                                name="query[tag]">
                                            <button class="btn btn-success mt-1"
                                                id="queryButton">Post</button>
                                        </form>
                                      
                            </div>
                            <div class="modal-footer mt-3">
                                <span class="fs-6" style="color: #4e4e4e;">
                                    Ask questions to get detailed info, personalized advice, and make confident, informed purchases, even get <b> Zen</b> points <br>
                                <b>**Usages of Tags</b><br>
                                Tags helps organize questions and answers, making it easier to find detailed info, get personalized advice, and make confident purchases. 
                                   </span>
                            </div>
                        </div>
                    </div>
                </div>
                <% if(product.queries.length> 0) {%>
                    <div class="accordion accordion-flush" id="accordionFlushExample">
                        <div class="card">
                            <div class="card-body">
                                <button class="accordion-button collapsed shadow-none p-0" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false"
                                    aria-controls="flush-collapseOne">
                                    Our Customers Frequently Asks!
                                </button>
                            </div>
                        </div>
                        <div id="flush-collapseOne" class="accordion-collapse collapse"
                            aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                            <div class="accordion-body">
                                <div class="card">
                                    <div class="card-body">
                                        <% for(let query of product.queries) { %>
                                            <div class="card mb-3">
                                                <div class="card-body position-relative p-0">
                                                    <div class="p-2">
                                                        <div class="d-flex">
                                                            <h4 class="">
                                                                <span>
                                                                    <img src="<%= query.author.profilePic %>"
                                                                        style="border-radius: 100%; object-fit: cover; height:60px; width: 60px;"
                                                                        class="img-thumbnail m-1" alt="">
                                                                </span>
                                                                <%= query.author.username %> asks
                                                            </h4> &nbsp;&nbsp;
                                                            <h6 class="mt-4 ms-2 text-muted">
                                                                <i>~ <small>
                                                                        <%= query.date.getDate() %>/<%=
                                                                                query.date.getMonth() + 1 %>/<%=
                                                                                    query.date.getFullYear() %>
                                                                    </small></i>
                                                            </h6>
                                                        </div>
                                                        <h6 class=" px-4 mb-0">
                                                            <%= query.question %> ?
                                                                <button class="btn btn-default" style="border: 0px"
                                                                    type="button" id="showReplies"
                                                                    data-bs-toggle="collapse"
                                                                    data-bs-target="#collapse<%= query.id %>"
                                                                    aria-expanded="false"
                                                                    aria-controls="collapse<%= query.id %>">
                                                                    View Replies
                                                                </button>
                                                        </h6>
                                                        <% if(currentUser && query.author.equals(currentUser._id)) {%>
                                                            <form
                                                                action='/customer/products/<%= product.id %>/queries/<%= query.id %>/?_method=DELETE'
                                                                method="post"
                                                                class=" position-absolute pe-2 pt-2  top-0 end-0">
                                                                <button
                                                                    class="btn btn-sm rounded p-2 btn-outline-danger mt-1">Delete</button>
                                                            </form>
                                                            <% } %>
                                                    </div>
                                                    <div class="ms-5 mb-2 collapse " id="collapse<%= query.id %>">
                                                        <% if(query.answers.length> 0) {%>
                                                            <% for(let replies of query.answers) {%>
                                                                <div class="d-flex flex-column">
                                                                    <div class="d-flex">
                                                                        <h5 class="m-0">
                                                                            <% if(replies.authorRole=='customer' ) {%>
                                                                                <span>
                                                                                    <img src="<%= replies.author.profile %>"
                                                                                        style="border-radius: 100%; object-fit: cover; width: 40px; height: 40px"
                                                                                        class="img-thumbnail mx-1 mt-1"
                                                                                        alt="">
                                                                                </span>
                                                                                <%= replies.author.username %> <small>(
                                                                                        <%= replies.authorRole %>
                                                                                            )
                                                                                    </small>
                                                                                    <% }%>
                                                                                        <% if(replies.authorRole=='seller'){ %>
                                                                                            <span>
                                                                                                <img src="<%= replies.author.profile %>"
                                                                                                    style="border-radius: 100%; object-fit: cover; width: 40px; height: 40px"
                                                                                                    class="img-thumbnail mx-1 mt-1"
                                                                                                    alt="">
                                                                                            </span>
                                                                                            <%=replies.author.username%>
                                                                                                <small>(<%=
                                                                                                        replies.authorRole%>
                                                                                                        )</small>
                                                                                                <% } %>
                                                                        </h5>
                                                                        <div class="mt-2 ms-2">
                                                                            <i>~ <small>
                                                                                    <%= replies.date.getDate() %>/
                                                                                        <%=replies.date.getMonth() + 11 %>/
                                                                                            <%=replies.date.getFullYear()%>
                                                                                </small></i>
                                                                        </div>
                                                                    </div>
                                                                    <div class="ms-5">
                                                                        <%= replies.answer %>&nbsp;
                                                                    </div>
                                                                </div>
                                                                <% } %>
                                                                    <% } %>
                                                    </div>
                                                    <% if(currentUser && !query.author.equals(currentUser._id)) {%>
                                                        <form
                                                            action='/customer/products/<%= product.id %>/queries/<%= query.id %>'
                                                            method="post" class=" d-flex p-2">
                                                            <input type="text" class="form-control p-2 m-0 " id="query"
                                                                name="answer">
                                                            <button
                                                                class="btn btn-sm btn-success px-3 py-1 ms-2">Post</button>
                                                        </form>
                                                        <% } %>

                                                </div>
                                            </div>
                                            <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>
            </div>
            <div class="col-md-6 mt-3">
                <div class="card">
                    <div class="card-body">
                        <center>
                            <h5 class="card-title">
                                <%= product.name%>
                            </h5>
                        </center>
                    </div>
                    <ul class="list-group list-group">
                        <% if(product.reviews.length> 0) {%>
                            <li class="list-group-item ">
                                Rating: <b>
                                    <%= parseFloat(product.rating*100 / 100).toFixed(1) %>
                                </b> based on <%= product.reviews.length %> reviews
                            </li>
                            <% } %>
                                <li class="list-group-item ">
                                    Price: &nbsp;&#8377;<%= product.price%>
                                </li>
                                <li class="list-group-item ">
                                    <%= product.description%>
                                </li>
                                <li class="list-group-item ">
                                    <%= product.category %>
                                </li>

                                <li class="list-group-item ">
                                    <b>By</b> ~ <b><a href="/seller/<%= product.seller.id %>"
                                            style="text-decoration: none; ">
                                            <%= product.seller.username %>
                                        </a></b>, <i>
                                        <%= product.seller.bussinessName %>
                                    </i>
                                    &nbsp; <a href="/chat/customer/<%= product.seller.id %>">Want to talk with the
                                        seller?</a>
                                </li>
                    </ul>
                </div>
                <br>
                <div class="card">
                    <div class="card-body">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#reviewModal">
                            Create Your Own Review
                        </button>
                        <div class="modal fade" id="reviewModal" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5">Leave a Review</h1>
                                        <button type="button" class="btn-close shadow-none" style="border: 0px"
                                            data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="card-body">
                                            <form action="/customer/products/<%=product.id %>/reviews" method="post"
                                                class="form-valid" novalidate>
                                                <div class="mb-3">
                                                    <label class="form-label" for="rating">Rate:</label>
                                                    <input type="range" min="1" max="5" name="review[rating]" required
                                                        class="form-range">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label" for="body">Review:</label>
                                                    <textarea class="form-control" name="review[body]" required
                                                        cols="30" rows="3"></textarea>
                                                    <div class="valid-feedback">
                                                        Looks good!
                                                    </div>
                                                    <div class="invalid-feedback">
                                                        Please give a title!
                                                    </div>
                                                    <button class="btn btn-success mt-3">Submit</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <% for(let review of product.reviews) {%>
                    <div class="card mb-3">
                        <div class="card-body  position-relative">
                            <div class="card-subtitle text-muted me-2">
                                <% if(currentUser && review.author.equals(currentUser)) {%>
                                    <h4>
                                        <span>
                                            <img src="<%= review.author.profilePic %>" width="50px" height="50px"
                                                style="border-radius: 100%; object-fit: cover; width: 50px; height: 50px"
                                                class="" alt="">
                                        </span> You
                                    </h4>
                                    <% }else{ %>
                                        <h4>
                                            <span>
                                                <img src="<%= review.author.profilePic %>"
                                                    style="border-radius: 100%; object-fit: cover; width: 50px; height: 50px"
                                                    class="img-thumbnail" alt="">
                                            </span>
                                            <%= review.author.username %>
                                        </h4>
                                        <% } %>
                            </div>
                            <h6 class="ms-2"><b>Rating: &nbsp;</b>
                                <% for(let i=1; i <=review.rating; i++) {%>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-star-fill mb-1" viewBox="0 0 16 16">
                                        <path
                                            d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z" />
                                    </svg>
                                    <% } %>
                            </h6>
                            <h6 class="ms-2"><b>Review: </b>
                                <%= review.body %>
                            </h6>
                            <h6 class="ms-2 mb-1  text-muted">
                                <i>Posted on~ &nbsp;&nbsp; <small>
                                        <%= review.date.getDay()%>/<%= review.date.getMonth() + 1 %>/<%=
                                                    review.date.getFullYear() %></i>
                                </small>
                            </h6>
                            <% if(currentUser && review.author.equals(currentUser._id)) {%>
                                <form
                                    action='/customer/products/<%= product.id %>/reviews/<%= review.id %>?_method=DELETE'
                                    method="post" class=" position-absolute pe-3 pt-3  top-0 end-0">
                                    <button class="btn btn-sm btn-danger">Delete</button>
                                </form>
                                <% } %>
                        </div>
                    </div>
                    <% } %>
            </div>
        </div>
    </div>